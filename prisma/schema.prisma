// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  citizen
  admin
  department_head
  department_staff
}

enum IncidentStatus {
  pending
  in_progress
  resolved
  rejected
}

enum IncidentCategory {
  vialidad
  salud
  ambiente
  seguridad
  alumbrado
  agua_alcantarillado
  transporte
  maltrato_animal
  basura
  otros
}

// Users table (reemplaza auth.users de Supabase)
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  profile Profile?
  
  @@map("users")
}

// Profiles table
model Profile {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  fullName    String   @map("full_name")
  phone       String?
  role        UserRole @default(citizen)
  departmentId String? @map("department_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  department      Department?  @relation(fields: [departmentId], references: [id])
  createdIncidents Incident[]  @relation("CitizenIncidents")
  assignedIncidents Incident[] @relation("AssignedIncidents")
  
  @@map("profiles")
}

// Departments table
model Department {
  id          String   @id @default(uuid())
  name        String
  description String?
  headId      String?  @map("head_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  profiles    Profile[]
  incidents   Incident[]
  categoryMappings CategoryDepartmentMapping[]
  
  @@map("departments")
}

// Incidents table
model Incident {
  id                      String          @id @default(uuid())
  title                   String
  description             String
  category                IncidentCategory
  status                  IncidentStatus  @default(pending)
  citizenId               String          @map("citizen_id")
  assignedDepartmentId   String?         @map("assigned_department_id")
  assignedStaffId         String?         @map("assigned_staff_id")
  latitude                Decimal?        @db.Decimal(10, 8)
  longitude               Decimal?        @db.Decimal(11, 8)
  address                 String?
  evidenceUrls            String[]        @map("evidence_urls")
  resolutionDescription   String?         @map("resolution_description")
  resolutionEvidenceUrls  String[]        @map("resolution_evidence_urls")
  resolvedAt              DateTime?       @map("resolved_at")
  createdAt               DateTime        @default(now()) @map("created_at")
  updatedAt               DateTime        @updatedAt @map("updated_at")
  
  citizen         Profile     @relation("CitizenIncidents", fields: [citizenId], references: [id])
  assignedDepartment Department? @relation(fields: [assignedDepartmentId], references: [id])
  assignedStaff   Profile?    @relation("AssignedIncidents", fields: [assignedStaffId], references: [id])
  
  @@map("incidents")
}

// Categories table
model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  icon        String?
  color       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("categories")
}

// Category-Department Mapping
model CategoryDepartmentMapping {
  id          String   @id @default(uuid())
  category    IncidentCategory
  departmentId String  @map("department_id")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at")
  
  department  Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  
  @@map("category_department_mapping")
}

